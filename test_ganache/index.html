<!DOCTYPE html>
<html>
    <head>
        <title>Ganache Local Testnet</title>
        <script src="https://cdn.jsdelivr.net/npm/ganache@7.8.0/dist/web/ganache.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.5.1/ethers.umd.min.js"></script>
    </head>
    <body>
        <button onclick="deployAndCallContract()">Deploy and Call Contract</button>
    </body>

    <script>
        async function deployAndCallContract() {
            const options = { 
                miner: { 
                    blockGasLimit : "0xffffffffffffffffffffffffffffffff",
                    callGasLimit : "0xffffffffffffffffffffffffffffffff",
                    defaultGasLimit : "0x0000",
                }
            };
            //const accounts = await provider.request({ method: "eth_accounts", params: [] });
            let provider = new ethers.BrowserProvider(Ganache.provider(options));
            let signer = await provider.getSigner(0);

            // 4.1kb
            const compiledBytecode = '608060405234801561001057600080fd5b5061072a806100206000396000f3fe608060405234801561001057600080fd5b506004361061004c5760003560e01c80632e6636521461005157806360b0d83314610074578063655d2c2714610051578063ce665dd814610089575b600080fd5b61005a611f4081565b60405163ffffffff90911681526020015b60405180910390f35b61007c610091565b60405161006b91906104b2565b61005a600081565b60408051611f40808252611f6082019092526060916000919060208201818036833701905050905060005b6100c96000611f406104fb565b63ffffffff16811015610175576100e160808261051f565b156100ed5760046100f0565b600a5b60ff1681901c61010160108361051f565b1561010d576006610110565b60045b60ff1682901c1760f81b82610126600084610541565b8151811061013657610136610554565b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a90535061016e8161056a565b90506100bc565b5061018281611f40610188565b91505090565b81516060906102417f52494646000000000000000000000000000000000000000000000000000000006101e36101bf84600c6104fb565b600881811c62ff00ff1663ff00ff009290911b9190911617601081811c91901b1790565b60e01b7f57415645666d74201000000001000100000000000000000000000000000000006102108761026a565b61021989610310565b60405160200161022d959493929190610583565b604051602081830303815290604052610388565b604051602001610251919061061c565b6040516020818303038152906040529150505b92915050565b600080600883811b63ff00ff001662ff00ff9185901c9190911617601081811b91901c1760405160e09190911b7fffffffff0000000000000000000000000000000000000000000000000000000081166020830181905260248301527f010008000000000000000000000000000000000000000000000000000000000060288301529150602c0160405160208183030381529060405261030990610661565b9392505050565b60607f646174610000000000000000000000000000000000000000000000000000000061035c8351600881811c62ff00ff1663ff00ff009290911b9190911617601081811c91901b1790565b60e01b83604051602001610372939291906106a2565b6040516020818303038152906040529050919050565b606060008083518015610486576003600282010460021b60405194507f4142434445464748494a4b4c4d4e4f505152535455565758595a616263646566601f526102308415027f6768696a6b6c6d6e6f707172737475767778797a303132333435363738392d5f03603f52602085018181015b6003880197508751603f8160121c1651600053603f81600c1c1651600153603f8160061c1651600253603f8116516003535060005182526004820191508082106103fb576020016040527f3d3d000000000000000000000000000000000000000000000000000000000000600384066002048083039190915260008515159091029182900352900384525b505050919050565b60005b838110156104a9578181015183820152602001610491565b50506000910152565b60208152600082518060208401526104d181604085016020870161048e565b601f01601f19169190910160400192915050565b634e487b7160e01b600052601160045260246000fd5b63ffffffff818116838216019080821115610518576105186104e5565b5092915050565b60008261053c57634e487b7160e01b600052601260045260246000fd5b500690565b81810381811115610264576102646104e5565b634e487b7160e01b600052603260045260246000fd5b60006001820161057c5761057c6104e5565b5060010190565b7fffffffff000000000000000000000000000000000000000000000000000000008681168252851660048201527fffffffffffffffffffffffffffffffff000000000000000000000000000000008416600882015273ffffffffffffffffffffffffffffffffffffffff1983166018820152815160009061060b81602485016020870161048e565b919091016024019695505050505050565b7f646174613a617564696f2f7761763b6261736536342c0000000000000000000081526000825161065481601685016020870161048e565b9190910160160192915050565b60008151602083015173ffffffffffffffffffffffffffffffffffffffff198082169350600c83101561048657600c9290920360031b82901b161692915050565b7fffffffff0000000000000000000000000000000000000000000000000000000084811682528316600482015281516000906106e581600885016020870161048e565b9190910160080194935050505056fea2646970667358221220e79f600286093b09a4aea8f1473b0c9e36bd05590668d77122f353d3b0a0d26864736f6c63430008130033';

            // figure this out after
            const abi = [
                "function getBeat() pure returns (string memory)"
            ];

            const factory = new ethers.ContractFactory(abi, compiledBytecode, signer);
            const contract = await factory.deploy();

            const deploymentReceipt = await contract.deploymentTransaction().wait();

            console.log("address:", deploymentReceipt.contractAddress);
            console.log("deployTransaction:", deploymentReceipt.hash);
            
            // Call the contract function
            try {
                const result = await contract.getBeat();
                console.log("getBeat result:", result);
                
                 // Create a new Audio element and set its source to the base64 string
                let audioElement = document.createElement('audio');
                audioElement.src = result;
                audioElement.autoplay = true;
                audioElement.controls = true;
                audioElement.loop = true;

                // Append the audio element to the body of the document
                document.body.appendChild(audioElement);

            } catch (error) {
                console.error("Error calling getBeat:", error);
            }
        }
    </script>
</html>